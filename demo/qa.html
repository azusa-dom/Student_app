<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎓 UCL AI 问答系统</title>
  <style>
    /* ——— 高级紫色渐变 + 圆角 + 玻璃态 ——— */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",sans-serif;
      min-height:100vh;padding:24px;background:linear-gradient(135deg,#667eea,#764ba2)}
    .container{max-width:900px;margin:0 auto}
    .header{text-align:center;color:#fff;margin-bottom:24px}
    .header h1{font-size:2.4rem;margin-bottom:8px}
    .card{background:#fff;border-radius:16px;padding:24px;
      box-shadow:0 12px 36px rgba(0,0,0,.12)}
    .pills{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 16px}
    .pill{border:2px solid #667eea;background:transparent;color:#667eea;
      padding:8px 16px;border-radius:999px;cursor:pointer;transition:.2s}
    .pill:hover{background:#667eea;color:#fff}
    .search{display:flex;gap:10px;margin-bottom:14px}
    #q{flex:1;padding:12px 14px;border:2px solid #e6e6f5;border-radius:10px;font-size:15px}
    #q:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.18)}
    #ask{background:#667eea;color:#fff;border:none;padding:12px 22px;border-radius:10px;
      font-weight:700;cursor:pointer;transition:.2s}
    #ask:hover:not(:disabled){background:#5568d3}
    #ask:disabled{background:#9aa4ff;cursor:not-allowed}
    .intent{display:inline-block;padding:6px 12px;border-radius:14px;
      background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700;font-size:13px;margin-bottom:12px}
    .answer{background:#f8f9fc;border-left:4px solid #667eea;padding:16px;border-radius:8px;white-space:pre-wrap;line-height:1.8;margin-bottom:14px}
    .answer a{color:#667eea;text-decoration:none}
    .answer a:hover{text-decoration:underline}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:8px 0 14px}
    .stat{background:#f8f9fc;border-radius:10px;padding:12px;text-align:center}
    .stat .k{font-size:12px;color:#7a84a2}.stat .v{font-size:20px;font-weight:800;color:#667eea}
    .src{border-top:2px solid #eee;padding-top:10px}
    .src h4{font-size:14px;color:#667eea;margin-bottom:8px}
    .src ul{list-style:none}
    .src li{background:#f8f9fc;padding:10px;border-radius:8px;margin-bottom:8px;border-left:3px solid transparent;transition:.2s}
    .src li:hover{background:#eef2ff;border-left-color:#667eea;transform:translateX(2px)}
    .loading,.error{padding:28px;text-align:center;color:#7a84a2}
    .spinner{width:40px;height:40px;border:4px solid rgba(102,126,234,.22);border-top-color:#667eea;border-radius:50%;margin:0 auto 10px;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:768px){.search{flex-direction:column}.stats{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎓 UCL AI 问答系统</h1>
      <p>智能检索 · 意图识别 · 精准回答</p>
    </div>

    <div class="card">
      <div style="color:#eef;opacity:.95;margin-bottom:8px">💡 试试这些问题</div>
      <div class="pills">
        <button class="pill" onclick="setQ('计算机科学硕士的语言要求')">计算机科学硕士的语言要求</button>
        <button class="pill" onclick="setQ('如何预约心理咨询')">如何预约心理咨询</button>
        <button class="pill" onclick="setQ('商科硕士入学要求')">商科硕士入学要求</button>
        <button class="pill" onclick="setQ('简历和求职准备')">简历和求职准备</button>
      </div>

      <div class="search">
        <input id="q" type="text" placeholder="请输入你的问题，例如：计算机科学硕士的语言要求" />
        <button id="ask" onclick="ask()">提问</button>
      </div>

      <div id="stage"></div>
    </div>
  </div>

  <script>
    const q = document.getElementById('q');
    const askBtn = document.getElementById('ask');
    const stage = document.getElementById('stage');
    q.addEventListener('keyup', e => { if (e.key === 'Enter') ask(); });

    const INTENT_TEXT = {
      admission_requirements: '📚 入学要求',
      careers_resume: '💼 职业发展',
      wellbeing_support: '❤️ 健康支持',
      booking: '📅 预约服务',
      other: '📄 其他',
      error: '❌ 错误'
    };

    function setQ(text){ q.value = text; q.focus(); }

    function loading(){
      stage.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          正在检索和总结，请稍候…
        </div>`;
    }
    function errorView(msg){
      stage.innerHTML = `<div class="error">❌ 系统错误：${msg||'连接失败'}</div>`;
    }

    async function ask(){
      const text = (q.value||'').trim();
      if(!text){ q.focus(); return; }
      askBtn.disabled = true; askBtn.textContent = '思考中…';
      loading();
      const t0 = Date.now();
      try{
        // 走 Vite 代理到 5051
        const res = await fetch(`/api/qa?query=${encodeURIComponent(text)}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        render(data, ((Date.now()-t0)/1000).toFixed(2)+'s');
      }catch(e){
        errorView(e.message);
      }finally{
        askBtn.disabled = false; askBtn.textContent = '提问';
      }
    }

    function render(data, cost='-'){
      const intent = INTENT_TEXT[data.intent] || data.intent || '其他';
      let answer = data.answer || '当前语料无该信息。';
      if (Array.isArray(data.citations) && data.citations.length>0){
        const c0 = data.citations[0];
        if (c0 && c0.url) answer += `\n\n来源：<a href="${c0.url}" target="_blank">${c0.title||c0.url}</a>`;
      }
      const docs = data.num_docs ?? (data.citations?.length||0);
      const rewrites = data.num_queries ?? '-';

      stage.innerHTML = `
        <div class="intent">${intent}</div>
        <div class="answer">${answer.replace(/\n/g,'<br/>')}</div>
        <div class="stats">
          <div class="stat"><div class="k">检索文档</div><div class="v">${docs}</div></div>
          <div class="stat"><div class="k">查询改写</div><div class="v">${rewrites}</div></div>
          <div class="stat"><div class="k">响应时间</div><div class="v">${cost}</div></div>
        </div>
        ${renderSources(data.citations)}
      `;
    }
    function renderSources(cites){
      if (!Array.isArray(cites) || cites.length===0) return '';
      const lis = cites.map((s,i)=>`
        <li>
          <strong>${i+1}. ${s.title||'相关页面'}</strong><br/>
          <a href="${s.url}" target="_blank">${s.url}</a>
        </li>`).join('');
      return `<div class="src"><h4>🔗 参考来源</h4><ul>${lis}</ul></div>`;
    }
  </script>
</body>
</html>
