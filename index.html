<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“ UCL AI Assistant - Redesigned</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    :root {
      --primary: #8B7BE8;
      --primary-dark: #6B5BC7;
      --primary-light: #A896F0;
      --secondary: #48bb78;
      --bg-gradient-1: #667eea;
      --bg-gradient-2: #764ba2;
      --text-dark: #2d3748;
      --text-light: #718096;
      --white: #ffffff;
      --error: #e53e3e;
      --success: #48bb78;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-1), var(--bg-gradient-2));
      min-height: 100vh;
      color: var(--text-dark);
      padding: 20px;
      transition: all 0.3s ease;
    }
    
    .container { 
      max-width: 1100px;
      margin: 0 auto;
    }
    
    /* Header Styles */
    header { 
      text-align: center;
      margin-bottom: 48px;
      color: var(--white);
      animation: fadeInDown 0.6s ease;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .logo {
      font-size: 56px;
      animation: bounce 2s infinite;
    }
    
    h1 { 
      font-size: 48px;
      font-weight: 800;
      text-shadow: 0 4px 20px rgba(0,0,0,0.2);
      line-height: 1.2;
    }
    
    .subtitle { 
      font-size: 18px;
      opacity: 0.95;
      margin-top: 12px;
      font-weight: 400;
    }
    
    /* Language Toggle */
    .lang-toggle {
      position: absolute;
      top: 24px;
      right: 24px;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 8px;
      display: flex;
      gap: 4px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      z-index: 100;
    }
    
    .lang-btn {
      background: transparent;
      border: none;
      color: var(--white);
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .lang-btn.active {
      background: var(--white);
      color: var(--primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .lang-btn:hover:not(.active) {
      background: rgba(255,255,255,0.15);
    }
    
    /* Status Badge */
    .status { 
      display: inline-block;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 12px 24px;
      border-radius: 24px;
      margin-top: 20px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    /* Main Card */
    .card { 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 32px;
      padding: 48px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      animation: fadeInUp 0.6s ease;
    }
    
    /* Quick Questions Section */
    .quick-questions-section {
      margin-bottom: 40px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 2px;
    }
    
    .questions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    
    .question-card {
      background: linear-gradient(135deg, rgba(139, 123, 232, 0.08), rgba(107, 91, 199, 0.05));
      border: 2px solid rgba(139, 123, 232, 0.15);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .question-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .question-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(139, 123, 232, 0.25);
      border-color: var(--primary);
    }
    
    .question-card:hover::before {
      opacity: 1;
    }
    
    .question-card:hover .question-content {
      color: var(--white);
    }
    
    .question-content {
      position: relative;
      z-index: 1;
    }
    
    .question-icon {
      font-size: 28px;
      margin-bottom: 12px;
      display: block;
    }
    
    .question-text {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.5;
      color: var(--text-dark);
      transition: color 0.3s ease;
    }
    
    .question-category {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 8px;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    
    .question-card:hover .question-category {
      color: rgba(255,255,255,0.8);
    }
    
    /* Search Box */
    .search-section {
      margin-bottom: 32px;
    }
    
    .search-box { 
      position: relative;
      margin-bottom: 16px;
    }
    
    #q { 
      width: 100%;
      padding: 20px 140px 20px 56px;
      border: 2px solid rgba(139, 123, 232, 0.2);
      border-radius: 20px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: var(--white);
      font-family: inherit;
    }
    
    #q::placeholder {
      color: var(--text-light);
    }
    
    #q:focus { 
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 6px rgba(139, 123, 232, 0.1);
      transform: translateY(-2px);
    }
    
    .search-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 24px;
      color: var(--text-light);
      pointer-events: none;
    }
    
    #ask { 
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      border: none;
      padding: 14px 32px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(139, 123, 232, 0.3);
    }
    
    #ask:hover:not(:disabled) { 
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 6px 20px rgba(139, 123, 232, 0.4);
    }
    
    #ask:disabled { 
      background: #cbd5e0;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .search-hint {
      font-size: 13px;
      color: var(--text-light);
      text-align: center;
      padding: 0 20px;
    }
    
    /* Loading State */
    .loading { 
      text-align: center;
      padding: 60px 20px;
    }
    
    .spinner { 
      width: 56px;
      height: 56px;
      border: 4px solid rgba(139, 123, 232, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      margin: 0 auto 24px;
      animation: spin 0.8s linear infinite;
    }
    
    .loading-text {
      font-size: 16px;
      color: var(--text-dark);
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .loading-subtext {
      font-size: 14px;
      color: var(--text-light);
    }
    
    /* Answer Box */
    .answer-container {
      animation: fadeIn 0.5s ease;
    }
    
    .intent-badge { 
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--secondary), #38a169);
      color: var(--white);
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }
    
    .answer-box { 
      background: linear-gradient(135deg, rgba(247, 250, 252, 0.95), rgba(237, 242, 247, 0.95));
      border-left: 5px solid var(--primary);
      border-radius: 16px;
      padding: 32px;
      line-height: 1.8;
      margin-bottom: 32px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      font-size: 16px;
    }
    
    .answer-box strong {
      color: var(--primary);
      font-weight: 700;
    }
    
    /* Stats Grid */
    .stats { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat { 
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 24px;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid rgba(139, 123, 232, 0.1);
    }
    
    .stat:hover { 
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      border-color: var(--primary);
    }
    
    .stat-label { 
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value { 
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    /* Sources Section */
    .sources { 
      border-top: 2px solid rgba(139, 123, 232, 0.15);
      padding-top: 28px;
      margin-top: 28px;
    }
    
    .sources h4 { 
      font-size: 16px;
      color: var(--text-dark);
      margin-bottom: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .source-item { 
      background: rgba(255, 255, 255, 0.9);
      padding: 18px 24px;
      border-radius: 14px;
      margin-bottom: 12px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .source-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--primary), var(--primary-dark));
      transition: width 0.3s ease;
    }
    
    .source-item:hover::before {
      width: 100%;
      opacity: 0.05;
    }
    
    .source-item:hover { 
      background: rgba(255, 255, 255, 1);
      transform: translateX(6px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }
    
    .source-item a { 
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      position: relative;
      z-index: 1;
    }
    
    .source-number {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
    }
    
    .source-content {
      flex: 1;
    }
    
    .source-title {
      font-size: 15px;
      line-height: 1.5;
      margin-bottom: 4px;
    }
    
    .source-score {
      font-size: 12px;
      color: var(--text-light);
      font-weight: 500;
    }
    
    /* Error State */
    .error { 
      background: linear-gradient(135deg, #fed7d7, #fcb8b8);
      border-left: 5px solid var(--error);
      padding: 24px;
      border-radius: 16px;
      color: #742a2a;
      animation: shake 0.5s ease;
    }
    
    .error-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Animations */
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      body { padding: 16px; }
      
      .card { 
        padding: 28px 20px;
        border-radius: 24px;
      }
      
      h1 { font-size: 36px; }
      
      .subtitle { font-size: 16px; }
      
      .lang-toggle {
        top: 16px;
        right: 16px;
      }
      
      .questions-grid {
        grid-template-columns: 1fr;
      }
      
      #q { 
        padding: 18px 120px 18px 48px;
        font-size: 15px;
      }
      
      .search-icon {
        left: 16px;
        font-size: 20px;
      }
      
      #ask {
        padding: 12px 24px;
        font-size: 14px;
      }
      
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stat-value {
        font-size: 28px;
      }
    }
    
    @media (max-width: 480px) {
      .header-content {
        flex-direction: column;
        gap: 8px;
      }
      
      h1 { font-size: 28px; }
      
      .stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Language Toggle -->
  <div class="lang-toggle">
    <button class="lang-btn active" data-lang="zh" onclick="switchLanguage('zh')">ä¸­æ–‡</button>
    <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">English</button>
  </div>

  <div class="container">
    <!-- Header -->
    <header>
      <div class="header-content">
        <span class="logo">ğŸ“</span>
        <h1 data-i18n="title">UCL AI Assistant</h1>
      </div>
      <p class="subtitle" data-i18n="subtitle">å¢å¼ºç‰ˆæ£€ç´¢ Â· æ™ºèƒ½æ£€ç´¢ Â· ç²¾å‡†å›ç­”</p>
      <div class="status" id="status">ğŸ”„ <span data-i18n="status-connecting">æ­£åœ¨è¿æ¥...</span></div>
    </header>

    <!-- Main Card -->
    <div class="card">
      <!-- Quick Questions Section -->
      <div class="quick-questions-section">
        <h3 class="section-title">
          <span data-i18n="quick-questions">ğŸ’¡ å¿«é€Ÿé—®é¢˜</span>
        </h3>
        <div class="questions-grid" id="questionsGrid">
          <!-- Questions will be dynamically generated -->
        </div>
      </div>

      <!-- Search Section -->
      <div class="search-section">
        <h3 class="section-title">
          <span data-i18n="custom-query">ğŸ” è‡ªå®šä¹‰æŸ¥è¯¢</span>
        </h3>
        <div class="search-box">
          <span class="search-icon">ğŸ”</span>
          <input 
            id="q" 
            data-i18n-placeholder="search-placeholder"
            placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜,ä¾‹å¦‚:Data Science MSc æœ‰å“ªäº›è¯¾ç¨‹æ¨¡å—?"
            onkeypress="if(event.key==='Enter')ask()"
          />
          <button id="ask" onclick="ask()">
            <span data-i18n="ask-btn">æé—®</span>
          </button>
        </div>
        <p class="search-hint" data-i18n="search-hint">ğŸ’¡ æ”¯æŒä¸­è‹±æ–‡æé—®,å¯è¯¢é—®ä¸“ä¸šä¿¡æ¯ã€å…¥å­¦è¦æ±‚ã€è¯¾ç¨‹æ¨¡å—ç­‰</p>
      </div>

      <!-- Results Stage -->
      <div id="stage"></div>
    </div>
  </div>

  <script>
    // API Configuration
    const API_BASE = window.location.origin;  // è‡ªåŠ¨ä½¿ç”¨å½“å‰åŸŸå
    
    // Language Translations
    const translations = {
      zh: {
        title: 'UCL AI åŠ©æ‰‹',
        subtitle: 'å¢å¼ºç‰ˆæ£€ç´¢ Â· æ™ºèƒ½æ£€ç´¢ Â· ç²¾å‡†å›ç­”',
        'status-connecting': 'æ­£åœ¨è¿æ¥...',
        'status-connected': 'åç«¯å·²è¿æ¥ (å¢å¼ºç‰ˆæ£€ç´¢)',
        'status-disconnected': 'åç«¯æœªå¯åŠ¨',
        'quick-questions': 'ğŸ’¡ å¿«é€Ÿé—®é¢˜',
        'custom-query': 'ğŸ” è‡ªå®šä¹‰æŸ¥è¯¢',
        'search-placeholder': 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜,ä¾‹å¦‚:Data Science MSc æœ‰å“ªäº›è¯¾ç¨‹æ¨¡å—?',
        'ask-btn': 'æé—®',
        'search-hint': 'ğŸ’¡ æ”¯æŒä¸­è‹±æ–‡æé—®,å¯è¯¢é—®ä¸“ä¸šä¿¡æ¯ã€å…¥å­¦è¦æ±‚ã€è¯¾ç¨‹æ¨¡å—ç­‰',
        'thinking': 'æ€è€ƒä¸­...',
        'searching': 'ğŸ” æ™ºèƒ½æ£€ç´¢ä¸­...',
        'analyzing': 'æ­£åœ¨åˆ†æç›¸å…³ä¿¡æ¯...',
        'error-title': 'âŒ æŸ¥è¯¢å‡ºé”™',
        'sources-title': 'ğŸ”— å‚è€ƒæ¥æº',
        'stat-docs': 'æ£€ç´¢æ–‡æ¡£',
        'stat-time': 'å“åº”æ—¶é—´',
        'stat-intent': 'æ„å›¾è¯†åˆ«',
        questions: [
          {
            icon: 'ğŸ“Š',
            text: 'è¯·é—® Data Science MSc ä¸“ä¸šæœ‰å“ªäº›æ ¸å¿ƒè¯¾ç¨‹æ¨¡å—?',
            category: 'è¯¾ç¨‹ä¿¡æ¯',
            query: 'What are the core modules in Data Science MSc?'
          },
          {
            icon: 'ğŸ’»',
            text: 'ç”³è¯· Computer Science MSc éœ€è¦æ»¡è¶³ä»€ä¹ˆè¯­è¨€è¦æ±‚?',
            category: 'å…¥å­¦è¦æ±‚',
            query: 'Computer Science MSc language requirements'
          },
          {
            icon: 'ğŸ§ ',
            text: 'æˆ‘æƒ³äº†è§£ UCL çš„å¿ƒç†å’¨è¯¢æœåŠ¡,å¦‚ä½•é¢„çº¦?',
            category: 'å­¦ç”ŸæœåŠ¡',
            query: 'å¦‚ä½•é¢„çº¦å¿ƒç†å’¨è¯¢'
          },
          {
            icon: 'ğŸ“ˆ',
            text: 'Business Analytics MSc çš„å…¥å­¦è¦æ±‚å’Œç”³è¯·æ¡ä»¶æ˜¯ä»€ä¹ˆ?',
            category: 'ç”³è¯·ä¿¡æ¯',
            query: 'Business Analytics MSc entry requirements'
          },
          {
            icon: 'ğŸ’°',
            text: 'å›½é™…å­¦ç”Ÿå°±è¯»å·¥ç¨‹ç±»ç¡•å£«çš„å­¦è´¹æ˜¯å¤šå°‘?',
            category: 'è´¹ç”¨å’¨è¯¢',
            query: 'Engineering MSc tuition fees for international students'
          },
          {
            icon: 'ğŸŒ',
            text: 'UCL ä¸ºå›½é™…å­¦ç”Ÿæä¾›å“ªäº›è¯­è¨€æ”¯æŒå’Œå¸®åŠ©?',
            category: 'å­¦ç”Ÿæ”¯æŒ',
            query: 'Language support for international students at UCL'
          }
        ]
      },
      en: {
        title: 'UCL AI Assistant',
        subtitle: 'Enhanced Search Â· Intelligent Retrieval Â· Accurate Answers',
        'status-connecting': 'Connecting...',
        'status-connected': 'Backend Connected (Enhanced)',
        'status-disconnected': 'Backend Not Running',
        'quick-questions': 'ğŸ’¡ Quick Questions',
        'custom-query': 'ğŸ” Custom Query',
        'search-placeholder': 'Enter your question, e.g., What modules are in Data Science MSc?',
        'ask-btn': 'Ask',
        'search-hint': 'ğŸ’¡ Supports both Chinese and English queries about programs, requirements, modules, etc.',
        'thinking': 'Thinking...',
        'searching': 'ğŸ” Searching intelligently...',
        'analyzing': 'Analyzing relevant information...',
        'error-title': 'âŒ Query Error',
        'sources-title': 'ğŸ”— Reference Sources',
        'stat-docs': 'Documents',
        'stat-time': 'Response Time',
        'stat-intent': 'Intent Detection',
        questions: [
          {
            icon: 'ğŸ“Š',
            text: 'What are the core modules in the Data Science MSc program?',
            category: 'Course Info',
            query: 'What are the core modules in Data Science MSc?'
          },
          {
            icon: 'ğŸ’»',
            text: 'What are the language requirements for Computer Science MSc?',
            category: 'Entry Requirements',
            query: 'Computer Science MSc language requirements'
          },
          {
            icon: 'ğŸ§ ',
            text: 'How can I book a psychological counseling session at UCL?',
            category: 'Student Services',
            query: 'How to book psychological counseling at UCL'
          },
          {
            icon: 'ğŸ“ˆ',
            text: 'What are the entry requirements for Business Analytics MSc?',
            category: 'Application Info',
            query: 'Business Analytics MSc entry requirements'
          },
          {
            icon: 'ğŸ’°',
            text: 'What are the tuition fees for Engineering MSc for international students?',
            category: 'Fees',
            query: 'Engineering MSc tuition fees for international students'
          },
          {
            icon: 'ğŸŒ',
            text: 'What language support does UCL offer to international students?',
            category: 'Support Services',
            query: 'Language support for international students at UCL'
          }
        ]
      }
    };
    
    // Current Language
    let currentLang = 'zh';
    
    // DOM Elements
    const q = document.getElementById('q');
    const askBtn = document.getElementById('ask');
    const stage = document.getElementById('stage');
    const status = document.getElementById('status');
    const questionsGrid = document.getElementById('questionsGrid');
    
    // Initialize
    function init() {
      renderQuestions();
      checkBackend();
      setInterval(checkBackend, 30000);
      console.log('[UCL AI] Redesigned v4.0 Initialized');
    }
    
    // Switch Language
    function switchLanguage(lang) {
      currentLang = lang;
      
      // Update active button
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      // Update all i18n elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        el.textContent = translations[lang][key] || key;
      });
      
      // Update placeholder
      const placeholder = document.querySelector('[data-i18n-placeholder]');
      if (placeholder) {
        placeholder.placeholder = translations[lang]['search-placeholder'];
      }
      
      // Re-render questions
      renderQuestions();
      
      // Update status if needed
      checkBackend();
    }
    
    // Render Quick Questions
    function renderQuestions() {
      const questions = translations[currentLang].questions;
      questionsGrid.innerHTML = questions.map(q => `
        <div class="question-card" onclick="quickAsk('${escapeHtml(q.query)}')">
          <div class="question-content">
            <span class="question-icon">${q.icon}</span>
            <div class="question-text">${q.text}</div>
            <div class="question-category">${q.category}</div>
          </div>
        </div>
      `).join('');
    }
    
    // Check Backend Status
    async function checkBackend() {
      try {
        const response = await fetch(API_BASE + '/api/health');
        if (response.ok) {
          status.innerHTML = 'âœ… ' + translations[currentLang]['status-connected'];
          status.style.background = 'rgba(72,187,120,0.3)';
          return true;
        }
      } catch (e) {
        console.warn('Backend check failed:', e);
      }
      status.innerHTML = 'âŒ ' + translations[currentLang]['status-disconnected'];
      status.style.background = 'rgba(229,62,62,0.3)';
      return false;
    }
    
    // Quick Ask
    function quickAsk(text) {
      q.value = text;
      setTimeout(ask, 150);
    }
    
    // Main Ask Function
    
  
  async function ask() {
    const text = (q.value || '').trim();
    if (!text) { q.focus(); return; }

    askBtn.disabled = true;
    askBtn.innerHTML = '<span data-i18n="thinking">' + translations[currentLang]['thinking'] + '</span>';

    stage.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <div class="loading-text">${translations[currentLang]['searching']}</div>
        <div class="loading-subtext">${translations[currentLang]['analyzing']}</div>
      </div>
    `;

    try {
      const resp = await fetch(API_BASE + '/api/qa', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: text, top_k: 5, language: currentLang })
      });

      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      let data;
      try {
        data = await resp.json();
      } catch (e) {
        throw new Error('è¿”å›çš„ä¸æ˜¯åˆæ³• JSONï¼š' + e.message);
      }

      // ç±»å‹å…œåº•
      if (!data || typeof data !== 'object') data = {};
      if (!Array.isArray(data.citations)) data.citations = [];
      if (!Array.isArray(data.reranked)) data.reranked = [];

      // è‡ªåŠ¨æ¨æ–­æ˜¯å¦ä½¿ç”¨äº†ç½‘ç»œæ¥æº
      const webSearchUsed = data.citations.some(s => s && s.source === 'web');

      // ç¼ºçœå€¼
      data.intent = data.intent || 'general';
      data.answer = (typeof data.answer === 'string' && data.answer.trim()) ? data.answer : 'æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯';
      data.response_time = (typeof data.response_time === 'string') ? data.response_time : '-';
      data.num_docs = (typeof data.num_docs === 'number') ? data.num_docs : (Array.isArray(data.reranked) ? data.reranked.length : 0);

      // ä¼ å…¥æ¨æ–­å€¼ï¼Œé¿å…å‰ç«¯å†è¯»ä¸€ä¸ªæœªå®šä¹‰å­—æ®µ
      data.web_search_used = webSearchUsed;

      renderAnswer(data);
    } catch (error) {
      console.error('[Error]', error);
      // æ˜¾ç¤ºåŸå§‹å“åº”ï¼ˆå¦‚æœæœ‰ï¼‰
      let rawText = '';
      try {
        // å¦‚æœ resp å·²å­˜åœ¨å¹¶å¯è¯»ï¼Œå°è¯•æ‰“å°å…¶æ–‡æœ¬
        if (typeof resp !== 'undefined' && resp && resp.text) {
          rawText = await resp.clone().text();
        }
      } catch (e) {
        rawText = '[æ— æ³•è¯»å–åŸå§‹å“åº”: ' + e.message + ']';
      }

      stage.innerHTML = `
        <div class="error">
          <div class="error-title">${translations[currentLang]['error-title']}</div>
          <div style="margin-bottom:8px;">${escapeHtml(error.message)}</div>
          <details open style="margin-top:8px;">
            <summary>è°ƒè¯•ä¿¡æ¯ï¼ˆåŸå§‹å“åº”ï¼‰</summary>
            <pre id="rawResp" style="white-space:pre-wrap;font-size:12px;background:#fff;padding:12px;border-radius:8px;overflow:auto;"></pre>
          </details>
        </div>
      `;

      // å¡«å……åŸå§‹å“åº”å†…å®¹ï¼ˆè‹¥æœ‰ï¼‰
      try {
        const pre = document.getElementById('rawResp');
        if (pre) pre.textContent = rawText || JSON.stringify({ error: String(error) }, null, 2);
      } catch (e) {
        console.warn('æ— æ³•å†™å…¥ rawResp:', e);
      }
    } finally {
      askBtn.disabled = false;
      askBtn.innerHTML = '<span data-i18n="ask-btn">' + translations[currentLang]['ask-btn'] + '</span>';
    }
  }

  function renderAnswer(data) {
    try {
      const intent = data.intent || 'general';
      let answer = data.answer || 'æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯';
      answer = escapeHtml(answer)
        .replace(/\\n/g, '<br/>')
        .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')
        .replace(/â€¢ /g, '&bull; ');

      const docs = (typeof data.num_docs === 'number') ? data.num_docs : 0;
      const responseTime = (typeof data.response_time === 'string') ? data.response_time : '-';

      const webSearchBadge = data.web_search_used
        ? '<span style="background: rgba(72,187,120,0.2); padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 8px;">ğŸŒ å«ç½‘ç»œæœç´¢</span>'
        : '';

      const intentLabels = {
        modules: 'ğŸ“š è¯¾ç¨‹æ¨¡å—',
        requirements: 'âœ… å…¥å­¦è¦æ±‚',
        language_requirements: 'âœ… è¯­è¨€è¦æ±‚',
        career: 'ğŸ’¼ èŒä¸šå‘å±•',
        fees: 'ğŸ’° å­¦è´¹æŸ¥è¯¢',
        services: 'ğŸ¯ å­¦ç”ŸæœåŠ¡',
        general: 'ğŸ” é€šç”¨æŸ¥è¯¢'
      };

      // æ„å»ºå¼•ç”¨
      let sourcesHtml = '';
      if (Array.isArray(data.citations) && data.citations.length > 0) {
        sourcesHtml = `
          <div class="sources">
            <h4>${translations[currentLang]['sources-title']}</h4>
            ${data.citations.map((source, index) => {
              if (!source || typeof source !== 'object') return '';
              const isWeb = source.source === 'web';
              const sourceType = isWeb
                ? '<span style="color: #48bb78; font-weight: 600;">ğŸŒ ç½‘ç»œ</span>'
                : '<span style="color: #8B7BE8; font-weight: 600;">ğŸ“š æœ¬åœ°</span>';
              const hasScore = typeof source.relevance_score === 'number' && !isNaN(source.relevance_score);
              const scoreText = hasScore
                ? `<span class="source-score">ç›¸å…³åº¦: ${source.relevance_score.toFixed(1)} | ${sourceType}</span>`
                : `<span class="source-score">${sourceType}</span>`;

              const url = (typeof source.url === 'string' && source.url.trim()) ? source.url : '';
              const title = (typeof source.title === 'string' && source.title.trim()) ? source.title : 'æ¥æº';

              return `
                <div class="source-item">
                  <a href="${escapeHtml(url || '#')}" target="_blank" ${!url ? 'style="pointer-events: none; color: #718096;"' : ''}>
                    <div class="source-number">${index + 1}</div>
                    <div class="source-content">
                      <div class="source-title">${escapeHtml(title)}</div>
                      ${scoreText}
                    </div>
                  </a>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      stage.innerHTML = `
        <div class="answer-container">
          <div class="intent-badge">
            ${intentLabels[intent] || 'ğŸ” ' + intent}
            ${webSearchBadge}
          </div>
          <div class="answer-box">${answer}</div>
          <div class="stats">
            <div class="stat">
              <div class="stat-label">${translations[currentLang]['stat-docs']}</div>
              <div class="stat-value">${docs}</div>
            </div>
            <div class="stat">
              <div class="stat-label">${translations[currentLang]['stat-time']}</div>
              <div class="stat-value">${escapeHtml(String(responseTime)).replace('s', '<small>s</small>')}</div>
            </div>
            <div class="stat">
              <div class="stat-label">${translations[currentLang]['stat-intent']}</div>
              <div class="stat-value">âœ“</div>
            </div>
          </div>
          ${sourcesHtml}
        </div>
      `;
    } catch (e) {
      console.error('[RenderError]', e);
      stage.innerHTML = `
        <div class="error">
          <div class="error-title">âŒ æ¸²æŸ“å‡ºé”™</div>
          <div>${escapeHtml(e.message)}</div>
        </div>
      `;
    }
  }

    // Utility: Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize on load
    init();
  </script>
</body>
</html>